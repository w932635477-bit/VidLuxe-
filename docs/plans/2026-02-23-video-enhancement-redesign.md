# 视频增强功能重新设计方案

## 背景

当前视频处理逻辑存在根本性问题：用户上传视频后，系统生成一个全新的背景图并制作短视频，输出的视频与原视频内容毫无关系。这完全背离了用户需求。

## 问题分析

### 当前错误流程

```
用户上传原视频 → 丢弃原视频 → AI生成新背景图 → FFmpeg生成5秒短视频
```

**问题**：完全没有使用用户上传的原视频内容。

### 用户真实需求

小红书博主（1-50万粉丝）上传3-7分钟视频，期望：
- 提升视频的"高级感"
- 解决拍摄时光线差、背景杂乱、色调不好等问题
- 让内容更容易"种草"

## 设计方案：混合交付模式

### 核心理念

1. **保留原视频内容** - 不重绘，只增强
2. **先预览再处理** - 用户看到效果才决定
3. **按需处理** - 封面即时，视频可选

### 整体流程

```
用户上传视频
    ↓
分析阶段（10-30秒）
├── 提取关键帧（5-10帧）
├── 分析视频色彩特征
└── 计算种草力评分
    ↓
预览阶段
├── 封面增强（AI处理最佳帧）
└── 调色预览（3种风格，5秒片段）
    ↓
用户选择
├── [下载封面] → 即时成品
├── [应用调色] → 处理完整视频（2-5分钟）
└── [下载LUT] → 调色参数文件
```

## 功能模块设计

### 模块1：关键帧提取与封面增强

#### 1.1 关键帧提取

**输入**：用户上传的视频文件

**处理**：
1. 按固定间隔提取帧（每2秒一帧）
2. 对每帧进行评分：
   - 清晰度（拉普拉斯方差）
   - 构图质量（三分法检测）
   - 人脸检测（如果有人脸则加分）
3. 返回评分最高的 5-10 帧

**输出**：关键帧图片列表（按评分排序）

#### 1.2 封面增强

**输入**：最佳关键帧

**处理**：
1. 调用 Nano Banana API 进行高级感增强
2. 保持人物主体，优化背景和色调

**输出**：增强后的封面图（PNG/JPG）

**用户界面**：
- 展示原图 vs 增强后对比
- "换一张"按钮选择其他关键帧
- "下载封面"按钮

### 模块2：视频调色滤镜

#### 2.1 色彩分析

**输入**：原视频

**处理**：
1. 使用 FFprobe 分析视频色彩特征
2. 计算平均亮度、饱和度、色调
3. 确定调色优化方向

#### 2.2 预设风格

| 风格 | 特点 | LUT描述 | 适用场景 |
|------|------|---------|----------|
| 杂志感 | 冷色调、高对比、高级灰 | 降低饱和度 + 提升对比 + 偏青 | 穿搭、美妆 |
| 暖调质感 | 温暖、柔和、金色调 | 提升暖色 + 降低对比 + 柔化 | 美食、探店 |
| 电影感 | 低饱和、青橙色调 | 阴影偏青 + 高光偏橙 | 生活方式、旅行 |

#### 2.3 调色处理

**预览模式**：
- 只处理视频前5秒
- 生成3种风格的预览片段
- 用户可对比选择

**完整处理**：
- 用户选择风格后
- 后台处理完整视频
- 显示进度条
- 完成后通知下载

#### 2.4 LUT导出

**说明**：为有剪辑能力的用户提供 .cube 格式的 LUT 文件，可在 Premiere、Final Cut 等软件中使用。

## 技术实现

### 关键帧提取

```typescript
// lib/keyframe-extractor.ts
export async function extractKeyFrames(videoPath: string): Promise<FrameScore[]> {
  // 1. 提取帧
  const frames = await extractFramesAtInterval(videoPath, 2); // 每2秒

  // 2. 评分
  const scored = frames.map(frame => ({
    frame,
    score: calculateFrameScore(frame),
  }));

  // 3. 排序返回 top 10
  return scored.sort((a, b) => b.score - a.score).slice(0, 10);
}

function calculateFrameScore(frame: Buffer): number {
  let score = 0;

  // 清晰度评分（拉普拉斯方差）
  score += calculateSharpness(frame) * 0.4;

  // 构图评分（基于三分法）
  score += calculateCompositionScore(frame) * 0.3;

  // 人脸检测加分
  if (hasFace(frame)) {
    score += 20;
  }

  return score;
}
```

### 调色处理

```typescript
// lib/color-grading.ts
const LUT_FILES = {
  magazine: 'luts/magazine.cube',
  warm: 'luts/warm.cube',
  cinematic: 'luts/cinematic.cube',
};

export async function applyColorGrading(
  videoPath: string,
  style: keyof typeof LUT_FILES,
  options: { preview?: boolean }
): Promise<string> {
  const lutPath = LUT_FILES[style];
  const duration = options.preview ? 5 : null; // null 表示完整视频

  const args = [
    '-i', videoPath,
    '-vf', `lut3d=${lutPath}`,
    '-c:v', 'libx264',
    '-preset', 'fast',
    '-y',
    outputPath,
  ];

  if (duration) {
    args.splice(0, 0, '-t', String(duration));
  }

  await execFFmpeg(args);
  return outputPath;
}
```

### API 端点设计

```
POST /api/video/analyze
- 分析视频，返回关键帧和色彩信息

POST /api/video/enhance-cover
- 增强指定的关键帧

POST /api/video/preview-grading
- 生成调色预览片段

POST /api/video/apply-grading
- 应用调色到完整视频（异步任务）

GET /api/video/lut/:style
- 下载 LUT 文件
```

## 用户界面流程

### Step 1: 上传

```
┌────────────────────────────────────┐
│  📹 上传你的视频                    │
│  ┌────────────────────────────────┐│
│  │   拖拽或点击上传                ││
│  │   MP4/MOV，最大 500MB           ││
│  └────────────────────────────────┘│
└────────────────────────────────────┘
```

### Step 2: 分析中

```
┌────────────────────────────────────┐
│  ⏳ AI 正在分析你的视频...          │
│  ████████████████░░░░░░░░ 65%      │
│  正在提取关键帧...                  │
└────────────────────────────────────┘
```

### Step 3: 选择封面

```
┌────────────────────────────────────┐
│  📸 选择你的高级感封面              │
│  ┌──────────┐  ┌──────────┐       │
│  │  原始帧   │  │ ✨ 增强  │       │
│  │          │  │          │       │
│  └──────────┘  └──────────┘       │
│                                    │
│  其他可选帧：                      │
│  [缩略1] [缩略2] [缩略3] [缩略4]  │
│                                    │
│  [换一张] [⬇ 下载这张封面]        │
└────────────────────────────────────┘
```

### Step 4: 选择调色

```
┌────────────────────────────────────┐
│  🎬 选择调色风格                    │
│                                    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐│
│  │ 杂志感  │ │ 暖调   │ │ 电影感 ││
│  │  ✓     │ │        │ │        ││
│  └─────────┘ └─────────┘ └─────────┘│
│                                    │
│  预览（前5秒）：                   │
│  [▶ 播放预览]                      │
│                                    │
│  [⬇ 下载LUT文件]                  │
│  [🎬 处理完整视频]                 │
└────────────────────────────────────┘
```

### Step 5: 处理中

```
┌────────────────────────────────────┐
│  🎬 正在处理完整视频...            │
│  ████████████████████░░░░ 80%     │
│  预计还需 1 分 30 秒               │
│                                    │
│  你可以离开此页面，完成后会通知你   │
└────────────────────────────────────┘
```

## 处理时间预估

| 操作 | 时间（3分钟视频） |
|------|------------------|
| 上传 | 视网络而定 |
| 分析+关键帧提取 | 15-30 秒 |
| 封面增强 | 30-60 秒 |
| 调色预览生成 | 20-40 秒 |
| 完整视频调色 | 2-5 分钟 |

## 实施计划

### Phase 1: 关键帧提取与封面增强（优先级最高）

1. 实现关键帧提取算法
2. 实现帧评分算法
3. 集成 Nano Banana 增强流程
4. 前端 UI 实现

### Phase 2: 视频调色滤镜

1. 准备 3 种 LUT 文件
2. 实现调色预览生成
3. 实现完整视频处理
4. LUT 下载功能

### Phase 3: 优化与迭代

1. 处理进度实时反馈
2. 错误处理优化
3. 性能优化

## 文件结构

```
apps/web/lib/
├── keyframe-extractor.ts    # 关键帧提取
├── frame-scorer.ts          # 帧评分算法
├── color-grading.ts         # 调色处理
├── lut-manager.ts           # LUT 文件管理
└── video-analyzer.ts        # 视频分析

apps/web/app/api/video/
├── analyze/route.ts         # 分析接口
├── enhance-cover/route.ts   # 封面增强
├── preview-grading/route.ts # 调色预览
├── apply-grading/route.ts   # 完整处理
└── lut/[style]/route.ts     # LUT 下载

apps/web/public/luts/
├── magazine.cube
├── warm.cube
└── cinematic.cube
```

## 验收标准

1. 用户上传视频后能看到原视频的关键帧
2. 封面增强后的图片保持人物主体，背景更有高级感
3. 调色预览能清晰展示风格差异
4. 完整视频处理后色调统一，无闪烁
5. 处理过程有明确的进度反馈

---

设计日期：2026-02-23
