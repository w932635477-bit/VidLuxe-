# 视频智能调色滤镜设计文档

## 概述

为 VidLuxe 添加视频智能调色功能，自动分析视频色彩问题，进行专业修复，并向用户解释调色原因，体现专业性。

## 目标用户

小红书博主，对色彩调色专业知识不了解，需要简单、自动、效果好的解决方案。

## 核心价值

- **零操作**：用户无需理解调色参数，系统自动分析优化
- **专业解释**：调色前展示专业文案，让用户理解"做了什么"和"为什么"
- **快速响应**：分析<3秒，预览<10秒，完整处理异步

## 整体流程（方案 D）

```
上传视频 → 智能调色 → 提取关键帧 → AI增强封面 → 封面嵌入视频开头
              ↓
        展示调色解释
```

### 详细流程

1. **上传视频** - 用户上传原始视频
2. **智能调色**
   - 分析视频色彩（3-5帧，<3秒）
   - 生成专业解释文案
   - 先展示解释，用户确认后处理
   - 生成调色后视频
3. **提取关键帧** - 从调色后的视频提取关键帧
4. **AI增强封面** - 基于调色后的关键帧进行风格化增强
5. **封面嵌入** - 将AI封面嵌入调色视频开头

## 技术方案

### 方案选择：FFmpeg 滤镜链

使用 FFmpeg 内置滤镜，无需额外依赖：

| 滤镜 | 用途 |
|------|------|
| `eq` | 亮度、对比度、饱和度调节 |
| `colorbalance` | 色温/色调校正 |
| `unsharp` | 锐化处理 |
| `hqdn3d` | 降噪处理 |

### 检测维度

| 维度 | 计算方式 | 标准范围 | FFmpeg 参数 |
|------|----------|----------|-------------|
| 亮度 | 提取帧平均像素值 | 100-150 | `eq=brightness` |
| 对比度 | 直方图标准差 | 50-80 | `eq=contrast` |
| 饱和度 | RGB 转 HSV 后平均 S 值 | 0.4-0.7 | `eq=saturation` |
| 色温 | R/B 通道比值 | 0.9-1.1 | `colorbalance` |
| 锐度 | 边缘检测梯度 | 适中 | `unsharp` |
| 噪点 | 暗部区域方差 | 低 | `hqdn3d` |

### 性能优化策略

- **分析阶段**：只提取 3-5 帧关键帧，快速计算（< 3秒）
- **预览阶段**：只处理视频前 3 秒作为预览（< 10秒）
- **完整处理**：后台异步，用户可离开页面

## 文件结构

```
/apps/web/
├── app/api/video/
│   ├── color-grade/route.ts      # 调色 API (新增)
│   ├── analyze/route.ts          # 视频分析 (已有)
│   ├── enhance-cover/route.ts    # 封面增强 (已有)
│   └── embed-cover/route.ts      # 封面嵌入 (已有)
├── lib/
│   ├── color-analyzer.ts         # 色彩分析器 (新增)
│   ├── color-corrector.ts        # 调色决策器 (新增)
│   └── ffmpeg-color-filters.ts   # FFmpeg 滤镜工具 (新增)
└── components/
    └── ColorGradeSection.tsx     # 调色UI组件 (新增)
```

## API 设计

### POST /api/video/color-grade

```typescript
// 请求
interface ColorGradeRequest {
  videoUrl: string;      // 原视频 URL
  previewOnly?: boolean; // true = 只生成3秒预览
}

// 响应 - 分析阶段（立即返回）
interface ColorGradeAnalysisResponse {
  success: true;
  analysis: {
    brightness: { value: number; status: string; adjustment: number };
    contrast: { value: number; status: string; adjustment: number };
    saturation: { value: number; status: string; adjustment: number };
    colorTemp: { value: number; status: string; adjustment: number };
    sharpness: { value: number; status: string; adjustment: number };
    noise: { value: number; status: string; adjustment: number };
  };
  explanation: string;  // 专业解释文案
}

// 响应 - 调色完成后（轮询获取）
interface ColorGradeResultResponse {
  success: true;
  videoUrl: string;      // 调色后完整视频
  previewUrl?: string;   // 预览视频（3秒）
}
```

## 解释文案模板

| 检测结果 | 文案模板 |
|----------|----------|
| 画面过暗 | "检测到画面整体偏暗，我们提升了**明亮度**，让细节更清晰可见。" |
| 对比度低 | "画面层次感不足，我们增强了**对比度**，让主体更突出。" |
| 色温偏冷 | "画面偏冷调，我们微调了**色温偏暖**，更符合小红书温馨氛围。" |
| 饱和度低 | "色彩略显平淡，我们提升了**鲜艳度**，让画面更生动。" |
| 画面模糊 | "检测到轻微模糊，我们进行了**锐化处理**，让边缘更清晰。" |
| 噪点较多 | "暗部有些许噪点，我们进行了**降噪处理**，让画面更干净。" |

**多问题组合示例：**
> "检测到您的视频**画面偏暗**且**对比度不足**。我们进行了智能优化：提升明亮度+15%，增强层次感+20%，让您的视频更通透有质感，更符合小红书的视觉风格。"

## UI 交互流程

```
┌─────────────────────────────────────────┐
│  上传视频                                │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  🔄 正在分析视频色彩... (3秒内)           │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  📊 分析结果                             │
│                                         │
│  "检测到您的视频画面偏暗且对比度不足。    │
│   我们将进行智能优化：                    │
│   • 提升明亮度 +15%                      │
│   • 增强层次感 +20%                      │
│   让您的视频更通透有质感。"              │
│                                         │
│  [开始调色]                              │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  🎬 调色预览                             │
│                                         │
│  ┌──────┐    ┌──────┐                   │
│  │ 原片 │ vs │ 调色后 │                  │
│  └──────┘    └──────┘                   │
│                                         │
│  [确认使用] [重新调整] [下载视频]         │
└─────────────────────────────────────────┘
```

## 与现有流程整合

调色功能作为流程的第一步（上传后立即执行），后续步骤全部基于调色后的视频：

1. **调色** → 输出调色后视频 URL
2. **提取关键帧** → 使用调色后视频 URL
3. **AI增强封面** → 使用调色后的关键帧
4. **封面嵌入** → 调色视频 + AI封面

## 决策记录

| 决策项 | 选择 | 理由 |
|--------|------|------|
| 调色目标 | 整个视频 | 用户要求 |
| 技术方案 | FFmpeg 滤镜链 | 无新依赖、速度快、够用 |
| 预设滤镜 | 放弃 | 用户认为作用不大 |
| 触发方式 | 自动分析 | 零操作体验 |
| 检测维度 | 6项全选 | 全面优化 |
| 核心价值 | 解释先行 | 体现专业性 |
| 流程位置 | 第一步 | 确保全链路色彩一致 |

## 下一步

调用 writing-plans 技能创建详细实现计划。
